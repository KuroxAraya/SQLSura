;WITH CTE AS(
    -- LIST EVERY RECORD
    SELECT PER_PRO, ID_HR, CAST(INI AS DATETIME) AS INI, CAST(FIN AS DATETIME) AS FIN, 
        RN = ROW_NUMBER()OVER(PARTITION BY ID_HR ORDER BY CAST(FIN AS DATETIME) DESC)
    FROM INF_LIC
    WHERE PER_PRO > 201712
), CTE2 AS(
    -- CALCULATE DATEDIFF
    SELECT T.*, 
        -- DATEDIFF BETWEEN INIn - FINn-1
        DD = CASE WHEN DATEDIFF(DD,T.FIN,T2.INI) IS NULL THEN 0 ELSE DATEDIFF(DD,T2.INI,T.FIN) END
    FROM CTE T
    -- LEFT JOIN ON EQUAL ID's AND RN = RN+1
    LEFT JOIN CTE T2 ON T.RN = T2.RN + 1 AND T.ID_HR = T2.ID_HR AND T.RN <> T2.RN
), CTE3 AS(
    SELECT PER_PRO, ID_HR, INI, FIN, RN, ABS(DD) AS DD,
    IND = (CASE WHEN DD = -1 THEN 'SEQ'
        WHEN DD = 0 THEN 'INICIAL'
        ELSE 'NOSEQ'
        END)
    FROM CTE2
    WHERE PER_PRO > 201712
), CTE4 AS(
    SELECT PER_PRO, ID_HR, INI, FIN, RN, DD, IND
    FROM CTE3
    --WHERE IND <> 'NOSEC'
    GROUP BY PER_PRO, ID_HR, INI, FIN, RN, DD, IND
    --HAVING RN >= 1 AND DATEADD(DD,-10,GETDATE()) < INI   
)
SELECT * FROM CTE4
ORDER BY ID_HR, RN ASC
